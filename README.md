# 🧩 Execution Environment & `run.sh` Usage Guide

본 프로젝트는 **Docker 기반 실행 환경**을 사용하며,
환경 일관성과 서버 간 이동성을 위해 **`run.sh` 스크립트**를 통해 컨테이너를 실행합니다.

---

## 1️⃣ ENV 설정을 사용하는 이유

### 🎯 목적

* **경로/캐시/사용자 환경을 코드에서 하드코딩하지 않기 위함**
* 서버마다 다른 홈 경로, 스토리지 구조를 **유연하게 대응**
* Docker 내부에서도 **호스트와 동일한 경로 체계**를 유지

### 🔧 주요 ENV 변수

컨테이너 실행 시 아래 환경 변수들이 전달됩니다.

* `HOST_USER` : 호스트 사용자 이름
* `HOST_UID` : 호스트 사용자 UID
* `HOST_GID` : 호스트 사용자 GID

이를 통해:

* 컨테이너 내부에서 생성된 파일의 **권한 문제 방지**
* NAS / 공용 스토리지 사용 시 **파일 소유권 충돌 최소화**

또한 일부 라이브러리(HF cache, HistoPLUS cache 등)는
**홈 디렉토리 기반 경로를 기본값으로 사용**하기 때문에
환경 변수 기반 제어가 중요합니다.

---

## 2️⃣ `run.sh`의 역할

`run.sh`는 단순한 `docker run` 래퍼가 아니라,
**실험용 컨테이너 실행을 표준화하기 위한 스크립트**입니다.

### ✔️ 주요 기능

* GPU 자동 활성화 (`--gpus all`)
* 현재 작업 디렉토리(`$PWD`)를 컨테이너 작업 디렉토리로 설정
* 호스트의 주요 경로를 **동일한 경로로 마운트**
* 사용자 UID/GID 전달
* 컨테이너 종료 시 자동 제거 (`--rm`)
* 필요 시 컨테이너 이름 지정 가능

---

## 3️⃣ 기본 사용법

```bash
./run.sh <IMAGE_NAME>
```

예시:

```bash
./run.sh # 기본으로 hist:base가 설정되어있음
./run.sh hist:base
```

* 컨테이너는 **현재 디렉토리 기준**으로 실행됩니다.
* 컨테이너 이름은 Docker가 자동 생성합니다.

---

## 4️⃣ 컨테이너 이름 지정 (`--name` 옵션)

여러 실험을 동시에 실행하거나
`docker ps`에서 컨테이너를 명확히 식별하고 싶은 경우 사용합니다.

```bash
./run.sh <IMAGE_NAME> --name <CONTAINER_NAME>
```

예시:

```bash
./run.sh hist:base --name histoplus-seg
```

> ⚠️ 동일한 이름의 컨테이너가 이미 존재하면 실행이 실패합니다.
> 필요 시 기존 컨테이너를 먼저 제거하십시오.

```bash
docker rm -f histoplus-seg
```

---

## 5️⃣ 자동 마운트되는 경로

아래 호스트 경로들은 **동일한 경로로 컨테이너에 마운트**됩니다.

* 현재 작업 디렉토리 (`$PWD`)
* `/home`
* `/data`
* `/home/nas2_fast`

> ❗ 해당 경로가 호스트에 존재하지 않으면 실행이 중단됩니다.

이 설계를 통해:

* 코드 내 경로 수정 없이 서버 이동 가능
* NAS / 공용 데이터 접근 시 경로 불일치 문제 방지

---

## 6️⃣ Docker 이미지에 대한 중요 안내 ⚠️

⚠️ **본 Docker 이미지는 “세그멘테이션/추론 중심” 환경입니다.**

* Cell segmentation, inference, feature extraction을 주 용도로 설계됨
* 다음과 같은 패키지는 **포함되어 있지 않거나 제한적일 수 있습니다**:

  * 데이터 분석/시각화용 라이브러리
  * 일부 통계/ML 패키지
  * 학습(training) 전용 프레임워크

👉 **추가 패키지가 필요한 경우**

* 별도 이미지 빌드
* 또는 컨테이너 내부에서 임시 설치 후 사용

을 권장합니다.

---

## 7️⃣ 권장 사용 패턴

* **세그멘테이션 / 추론 작업**
  → 본 Docker + `run.sh` 사용
* **분석 / 시각화 / 실험적 코드**
  → 별도 환경 또는 확장 이미지 권장
* **여러 실험 병렬 실행**
  → `--name` 옵션으로 컨테이너 구분

---

## 8️⃣ 문제 발생 시 체크리스트

1. `docker ps`에서 컨테이너가 실행 중인지
2. 컨테이너 이름 충돌 여부 (`--name` 사용 시)
3. 마운트 경로가 호스트에 실제로 존재하는지
4. GPU 인식 여부 (`nvidia-smi`)
5. 필요한 패키지가 이미지에 포함되어 있는지

---

### 📌 요약

* `run.sh`는 **실험 환경 표준화용 실행 스크립트**
* ENV 설정은 **경로/권한/캐시 문제를 피하기 위한 필수 설계**
* Docker 이미지는 **세그멘테이션 중심**, 범용 개발 환경이 아님

